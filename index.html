<!DOCTYPE html>
<html lang="es" ng-app="MyApp">
<head>
<meta charset="utf-8">
<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
<script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.2.26/angular.min.js"></script>
<script src="google-plus-signin.js"></script>
</head>
<body ng-controller="MyController">

<div class="container">
<div class="page-header">
   <h3>Escuela Profesional de Ingeniería de Sistemas
      <small>Prematriculas</small>
   </h3>
</div>

<div ng-hide="signedIn" class="ng-hide">
<google-plus-signin clientid="57529820170-8jv5ofsrhrnep4bfs7g32d5k5p9pmdno.apps.googleusercontent.com" language="es"></google-plus-signin>
</div>

<div ng-show="signedIn">
<div class="alert alert-info" role="alert">
<p ng-bind="studentData"></p>
</div>

<div ng-show="validUser">
<div class="panel-body">
<form name="coursesForm" ng-submit="send()">
<table class="table table-striped">
<tr>
<th> </th>
<th>Código</th><th>Nombre</th><th>Créditos</th><th>Semestre</th>
</tr>
<tr ng-repeat="course in courses">
<td><input type="checkbox" ng-model="selection.ids[course.id]" name="chosen" id="{{course.id}}" /></td>
<td>{{course.id}}</td><td>{{course.name}}</td><td>{{course.credits}}</td><td>{{course.semester}}</td>
</tr>
</table>

<button type="submit" class="btn btn-default">Matricular</button>

<div class="{{creditAlert}}" role="alert">
<p> Total de créditos: {{ computeTotal() }}</p>
</div>

<!--pre ng-bind="selection | json"></pre-->

</form>
</div>
</div>
</div>

</div>

<script type="text/javascript">
(function() {
 var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
 po.src = 'https://apis.google.com/js/client:plusone.js';
 var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
 })();
</script>
<script src="https://apis.google.com/js/client.js?onload=handleClientLoad"></script>
</body>
<script>
var app = angular.module("MyApp", ['directive.g+signin']);

app.controller('MyController', function($scope, $http){
  $scope.signedIn = false;
  $scope.key = "";
  $scope.count = 0;
  $scope.cui = "";
  $scope.courses = [];
  $scope.selection = {ids:{1301106: true}};
  $scope.maxCredits;
  $scope.creditAlert = "alert alert-success";
  $scope.validUser = false;

  $scope.computeTotal = function() {
    var total = 0;
    angular.forEach($scope.courses, function(course){
      if($scope.selection.ids[course.id]){
        total += parseInt(course.credits);
      }
    });
    if(total <= 0){
      $scope.creditAlert = "alert alert-warning";
    }else if(total > $scope.maxCredits){
      $scope.creditAlert = "alert alert-danger";
    }else{
      $scope.creditAlert = "alert alert-success";
    }
    return total;
  }
  $scope.$on('event:google-plus-signin-success', function (event,authResult) {
    $scope.signedIn = true;
    $scope.key = authResult.access_token;
    $http({
      method: 'GET',
      url: 'name.php',
      params:{ key:$scope.key }
    }).success(function(data){
      $scope.maxCredits = data.credits;
      $scope.studentData = data.firstName + " " + data.lastName + " tiene cursos en " + data.time + " matrícula, máximo " + data.credits + " créditos";
      $http({
        method: 'GET',
        url: 'remember.php',
        params:{ key:$scope.key }
      }).success(function(data){
        $scope.selection = data;
      });
      $http({
        method: 'GET',
        url: 'matricula.php',
        params:{key:$scope.key}
      }).success(function(data){
        $scope.courses = data;
      });
      $scope.validUser = true;
    }).error(function(data){
      $http({
        type: "GET",
        url: "https://www.googleapis.com/oauth2/v2/userinfo?access_token="+authResult.access_token
      }).success(function( data ){
        $scope.studentData = data.email + ", no está registrado en nuestra base de datos";
        $scope.validUser = false;
      });
    });
  });
  $scope.send = function(){
    $http({
      method: 'GET',
      url: 'update.php',
      params:{ key:$scope.key, chosen: JSON.stringify($scope.selection.ids)}
    }).success(function(data){
        window.alert("Prematricula concluida con éxito");
    });
  };
});
</script>
</html>
